<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Juego de Memoria</title>
  <style>
    :root {
      --bg-normal: #e8eaf6;
      --bg-dark: #191d24;
      --color-primary: #283593;
      --color-primary-dark: #b3bcf7;
      --cartas-fondo: #3949ab;
      --cartas-texto: #fff;
      --cartas-volteada-bg: #fff;
      --cartas-volteada-color: #3949ab;
      --cartas-pareja-bg: #66bb6a;
      --cartas-pareja-color: #fff;
      --modal-fondo: rgba(0,0,0,0.35);
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg-normal);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background 0.2s;
    }
    body.oscuro { background: var(--bg-dark); }
    h1 {
      color: var(--color-primary);
      cursor: pointer;
      user-select: none;
      transition: text-shadow 0.2s, color 0.25s;
    }
    body.oscuro h1 { color: var(--color-primary-dark); }
    h1:active { text-shadow: 0 1px 8px #e0eeff; }
    .animar-titulo {
      animation: giroRebote 0.9s cubic-bezier(.41,1.7,.65,.89) 1;
    }
    @keyframes giroRebote {
      0%   { transform: scale(1) rotate(0deg); letter-spacing:0; }
      15%  { transform: scale(1.18,0.93) rotate(-18deg); letter-spacing:2px; }
      35%  { transform: scale(0.91,1.10) rotate(15deg);}
      50%  { transform: scale(1.08,0.94) rotate(-9deg);}
      65%  { transform: scale(0.97,1.06) rotate(6deg);}
      80%  { transform: scale(1.04,0.99) rotate(-3deg);}
      100% { transform: scale(1) rotate(0deg); letter-spacing:0; }
    }
    #easter-egg-msg {
      display: none;
      position: fixed;
      top: 38px; left: 0; width: 100vw;
      text-align: center;
      z-index: 2000;
      font-size: 1.25em;
      color: #fff;
      background: #fbc02d;
      filter: drop-shadow(0 0 18px #fcbb0040);
      padding: 10px 0 8px 0;
      letter-spacing: 2px;
      font-weight: bold;
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
      pointer-events: none;
      opacity: 0.92;
      animation: fadeMsg 2s;
    }
    @keyframes fadeMsg {
      0% {opacity: 0;}
      5% {opacity: 0.92;}
      80% {opacity: 0.92;}
      100% {opacity: 0;}
    }
    #modo-oscuro-btn {
      position: absolute;
      top: 14px; right: 26px;
      z-index: 99;
      padding: 6px 20px;
      border-radius: 18px;
      background: var(--cartas-fondo);
      color: #fff;
      border: none;
      font-weight: bold;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      box-shadow: 0 2px 12px #2221;
    }
    body.oscuro #modo-oscuro-btn {
      background: #fff;
      color: var(--bg-dark);
      border: 1px solid #232637;
    }
    body.oscuro label { color: #fff; }
    #tablero { display: grid; gap: 10px; }
    .carta {
      width: 70px; height: 70px;
      background: var(--cartas-fondo);
      color: var(--cartas-texto);
      font-size: 2em; display: flex;
      align-items: center; justify-content: center;
      border-radius: 8px; cursor: pointer;
      user-select: none;
      transition: background 0.3s, color 0.3s;
      box-shadow: 0 1px 10px 2px #28359314;
    }
    .volteada { background: var(--cartas-volteada-bg); color: var(--cartas-volteada-color); cursor: default;}
    .pareja { background: var(--cartas-pareja-bg); color: var(--cartas-pareja-color);}
    body.oscuro .carta { background: #232637; color: #c3d1ff; }
    body.oscuro .volteada { background: #f3f6fd; color: #232637; }
    body.oscuro .pareja { background: #297a45; color: #fff; }
    #movimientos, #cronometro, #record {
      margin: 10px 0 0 0;
      font-size: 1.2em;
      font-weight: bold;
      transition: color 0.2s;
    }
    body.oscuro #movimientos, body.oscuro #cronometro, body.oscuro #record {
      color: var(--color-primary-dark);
    }
    button, select { padding: 6px 16px; margin-top: 10px; font-size: 1em; }
    #dificultad, #modo { margin-bottom: 10px;}
    #memoria-juego, #reiniciar-btn, #volver-menu-btn, #abandonar-btn, #reset-record-btn { display: none; }
    #felicitaciones {
      color: #2E7D32;
      font-weight: bold;
      margin: 15px 0 0 0;
      font-size: 1.2em;
      letter-spacing: 2px;
      text-shadow: 0 1px 20px #aadbb9;
      opacity: 1;
    }
    body.oscuro #felicitaciones { color: #7ecc98; text-shadow: 0 1px 16px #294537;}
    .animar-felicidades {
      animation: victoriaZoom 1.1s cubic-bezier(.15, 1.49, .31, .77) 1;
    }
    @keyframes victoriaZoom {
      0%   { transform: scale(0.5) rotate(-7deg); opacity:0;}
      15%  {transform:scale(1.4) rotate(7deg);}
      30%  {transform:scale(1) rotate(-4deg);}
      55%  {transform:scale(1.09);}
      80%  {transform:scale(1);}
      100% {transform:scale(1) rotate(0); opacity:1;}
    }
    #nuevo-record {
      color: #F57C00;
      font-weight: bold;
      margin-top: 8px;
      font-size: 1.3em;
      opacity: 1;
    }
    .animar-record {
      animation: saltoRecord 1.1s cubic-bezier(.22,2,.37,.54) 1;
    }
    @keyframes saltoRecord {
      0%   { transform: scale(1) translateY(0);   opacity: 0; }
      5%   { transform: scale(1.15, 0.85) translateY(0); opacity: 1;}
      15%  { transform: scale(1.2, 0.8) translateY(-10px);}
      30%  { transform: scale(0.95, 1.05) translateY(0);}
      45%  { transform: scale(1.05, 0.94) translateY(-6px);}
      60%  { transform: scale(1,1) translateY(0);}
      75%  { transform: scale(1,1) translateY(-4px);}
      100% { transform: scale(1,1) translateY(0);  opacity: 1;}
    }
    #botonera-juego { margin-top: 10px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    #modal-fondo {
      display: none;
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: var(--modal-fondo);
      z-index: 50;
      justify-content: center; align-items: center;
    }
    body.oscuro #modal-fondo { background: rgba(0,0,0,0.7);}
    #modal-confirmacion {
      background: #fff;
      padding: 25px 22px;
      border-radius: 12px;
      box-shadow: 0 0 14px #3338;
      min-width: 270px;
      text-align: center;
      z-index: 51;
      animation: popupin 0.22s;
      color: #23282f;
    }
    #modal-confirmacion p {
      font-size: 1.05em; margin-bottom: 24px;
    }
    #modal-confirmacion button {
      margin: 0 10px 0 10px; min-width: 95px;
    }
    @keyframes popupin {
      0% { transform: scale(0.7); opacity: 0;}
      80% {transform: scale(1.1); }
      100% {transform: scale(1); opacity: 1;}
    }
    body.oscuro #modal-confirmacion { background: #1c2030; color: #deeafc;}
    ::selection { background: #c8d0fd; }
    body.oscuro ::selection { background: #3c4260; }
    #confetti-canvas {
      position: fixed;
      pointer-events: none;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      z-index: 9999;
      display:none;
    }
  </style>
</head>
<body>
  <div id="easter-egg-msg"></div>
  <button id="modo-oscuro-btn" onclick="toggleModoOscuro()">Modo oscuro</button>
  <h1 id="titulo-juego" title="Â¡Hazme clic!">Juego de Memoria</h1>
  <div id="menu">
    <label for="dificultad">Dificultad: </label>
    <select id="dificultad">
      <option value="facil">FÃ¡cil (4 pares)</option>
      <option value="media" selected>Media (8 pares)</option>
      <option value="dificil">DifÃ­cil (12 pares)</option>
    </select>
    <label for="modo" style="margin-left:20px;">Modo: </label>
    <select id="modo">
      <option value="movimientos" selected>Movimientos</option>
      <option value="reloj">Reloj</option>
    </select>
    <button onclick="mostrarJuego()">Iniciar juego</button>
  </div>
  <div id="memoria-juego">
    <div id="movimientos">Movimientos: <span id="contMovimientos">0</span></div>
    <div id="cronometro">Tiempo: <span id="tiempo">00:00</span></div>
    <div id="record"></div>
    <div id="tablero"></div>
    <div id="felicitaciones"></div>
    <div id="nuevo-record"></div>
    <div id="botonera-juego">
      <button id="reiniciar-btn" onclick="iniciarJuego()">Reiniciar</button>
      <button id="abandonar-btn" onclick="volverAlMenu()">Abandonar partida</button>
      <button id="reset-record-btn" onclick="abrirModalConfirmacion()">Reiniciar rÃ©cord</button>
    </div>
  </div>
  <button id="volver-menu-btn" onclick="volverAlMenu()">Volver al menÃº</button>
  <div id="modal-fondo">
    <div id="modal-confirmacion">
      <p>Â¿EstÃ¡s seguro de que quieres borrar el rÃ©cord actual de este modo y dificultad?</p>
      <button onclick="confirmarResetRecord()" style="background: #F57C00;color:#fff;">SÃ­, borrar</button>
      <button onclick="cerrarModalConfirmacion()">Cancelar</button>
    </div>
  </div>
  <canvas id="confetti-canvas"></canvas>
  <script>
    // Easter Egg: TÃ­tulo 5 clics => alterna frutas/emojis
    let frutasOriginales = [
      'ðŸŽ','ðŸŒ','ðŸ‡','ðŸ’','ðŸ‰','ðŸ‹','ðŸ','ðŸ“','ðŸ','ðŸ¥','ðŸ¥¥','ðŸ¥‘','ðŸ†','ðŸŠ','ðŸ‘','ðŸˆ'
    ];
    let emojisDivertidos = [
      'ðŸ˜€','ðŸ˜‚','ðŸ˜Ž','ðŸ¤©','ðŸ˜˜','ðŸ˜¡','ðŸ¥¶','ðŸ¤–','ðŸ‘¾','ðŸ±','ðŸ¸','ðŸµ','ðŸ¼','ðŸ¦„','ðŸ·','ðŸ‘½','ðŸš€','ðŸŽƒ','ðŸ•','âš½','ðŸŽ©','ðŸ”','ðŸŸ','ðŸ†'
    ];
    let enModoEmojis = false;
    let clickCount = 0;
    let clickTimer = null;
    document.getElementById('titulo-juego').addEventListener('click', function() {
      const titulo = this;
      titulo.classList.remove('animar-titulo');
      void titulo.offsetWidth;
      titulo.classList.add('animar-titulo');
      clickCount++;
      if (clickCount === 1) {
        clickTimer = setTimeout(() => { clickCount = 0; }, 2000);
      }
      if (clickCount === 5) {
        if (enModoEmojis) {
          activarModoFrutas();
        } else {
          activarModoEmojis();
        }
        clickCount = 0;
        clearTimeout(clickTimer);
      }
    });
    function activarModoEmojis() {
      enModoEmojis = true;
      mostrarEasterEggMsg("Â¡Modo emojis activado!");
      iniciarJuego();
    }
    function activarModoFrutas() {
      enModoEmojis = false;
      mostrarEasterEggMsg("Â¡Modo frutas activado!");
      iniciarJuego();
    }
    function mostrarEasterEggMsg(msg) {
      const msgDiv = document.getElementById('easter-egg-msg');
      msgDiv.textContent = msg;
      msgDiv.style.display = 'block';
      msgDiv.classList.remove('fadeMsg');
      setTimeout(() => {
        msgDiv.style.display = 'none';
      }, 1700);
    }

    // Modo oscuro
    function setModoOscuro(oscuro) {
      document.body.classList.toggle('oscuro', oscuro);
      document.getElementById('modo-oscuro-btn').innerText = oscuro ? "Modo claro" : "Modo oscuro";
      localStorage.setItem('modoOscuro', oscuro ? '1' : '0');
    }
    function toggleModoOscuro() {
      setModoOscuro(!document.body.classList.contains('oscuro'));
    }
    window.addEventListener('DOMContentLoaded', () => {
      let oscuro = localStorage.getItem('modoOscuro') === '1';
      setModoOscuro(oscuro);
    });

    // Juego de memoria
    let tablero = [];
    let volteadas = [];
    let parejasEncontradas = 0;
    let movimientos = 0;
    let cantidadPares = 8;
    let columnas = 4;
    let juegoTerminado = false;
    let modo = "movimientos";
    let intervalo = null;
    let tiempoTranscurrido = 0;
    let jugando = false;

    function recordKey(dif, modo) {
      return "record_" + dif + "_" + modo + (enModoEmojis ? "_emojiEaster" : "");
    }
    function obtenerRecord(dif, modo) {
      let key = recordKey(dif, modo);
      let dato = localStorage.getItem(key);
      return dato ? Number(dato) : null;
    }
    function guardarRecord(dif, modo, valor) {
      localStorage.setItem(recordKey(dif, modo), String(valor));
    }
    function borrarRecord(dif, modo) {
      localStorage.removeItem(recordKey(dif, modo));
    }
    function mostrarRecord() {
      const dif = document.getElementById('dificultad').value;
      const mod = document.getElementById('modo').value;
      let record = obtenerRecord(dif, mod);
      let texto = '';
      if (record == null) {
        texto = 'RÃ©cord: â€“';
      } else if (mod === 'movimientos') {
        texto = `RÃ©cord: ${record} movimientos`;
      } else {
        texto = `RÃ©cord: ${formarTiempo(record)}`;
      }
      if (enModoEmojis) texto += " ðŸ¥š";
      document.getElementById('record').textContent = texto;
    }
    function mostrarNuevoRecordAnimado() {
      const nuevoRecordDiv = document.getElementById('nuevo-record');
      nuevoRecordDiv.textContent = "Â¡Nuevo rÃ©cord!";
      nuevoRecordDiv.classList.remove('animar-record');
      void nuevoRecordDiv.offsetWidth;
      nuevoRecordDiv.classList.add('animar-record');
    }
    function abrirModalConfirmacion() {
      document.getElementById('modal-fondo').style.display = 'flex';
    }
    function cerrarModalConfirmacion() {
      document.getElementById('modal-fondo').style.display = 'none';
    }
    function confirmarResetRecord() {
      const dif = document.getElementById('dificultad').value;
      const mod = document.getElementById('modo').value;
      borrarRecord(dif, mod);
      mostrarRecord();
      document.getElementById('nuevo-record').textContent = '';
      document.getElementById('nuevo-record').classList.remove('animar-record');
      cerrarModalConfirmacion();
    }
    function mostrarJuego() {
      document.getElementById('menu').style.display = 'none';
      document.getElementById('memoria-juego').style.display = 'block';
      document.getElementById('reiniciar-btn').style.display = 'inline-block';
      document.getElementById('abandonar-btn').style.display = 'inline-block';
      document.getElementById('reset-record-btn').style.display = 'inline-block';
      document.getElementById('volver-menu-btn').style.display = 'none';
      document.getElementById('felicitaciones').textContent = '';
      document.getElementById('nuevo-record').textContent = '';
      document.getElementById('nuevo-record').classList.remove('animar-record');
      cerrarModalConfirmacion();
      juegoTerminado = false;
      iniciarJuego();
    }
    function iniciarJuego() {
      const dif = document.getElementById('dificultad').value;
      if (dif === 'facil') { cantidadPares = 4; columnas = 4; }
      else if (dif === 'media') { cantidadPares = 8; columnas = 4; }
      else if (dif === 'dificil') { cantidadPares = 12; columnas = 6; }
      modo = document.getElementById('modo').value;
      document.getElementById('movimientos').style.display = modo === 'movimientos' ? 'block' : 'none';
      document.getElementById('cronometro').style.display = modo === 'reloj' ? 'block' : 'none';
      mostrarRecord();
      let fuenteEmojis = enModoEmojis ? emojisDivertidos : frutasOriginales;
      let emojis = fuenteEmojis.slice(0, cantidadPares);
      let cartas = [...emojis, ...emojis].sort(()=>0.5-Math.random());
      const tableroDiv = document.getElementById('tablero');
      tableroDiv.innerHTML = '';
      tablero = [];
      volteadas = [];
      parejasEncontradas = 0;
      movimientos = 0;
      juegoTerminado = false;
      jugando = false;
      document.getElementById('contMovimientos').textContent = '0';
      const felicDiv = document.getElementById('felicitaciones');
      felicDiv.textContent = '';
      felicDiv.classList.remove('animar-felicidades');
      document.getElementById('volver-menu-btn').style.display = 'none';
      document.getElementById('nuevo-record').textContent = '';
      document.getElementById('nuevo-record').classList.remove('animar-record');
      document.getElementById('reset-record-btn').style.display = 'inline-block';
      cerrarModalConfirmacion();
      tiempoTranscurrido = 0;
      actualizarCronometro();
      detenerCronometro();
      tableroDiv.style.gridTemplateColumns = `repeat(${columnas}, 70px)`;
      for (let i=0; i<cartas.length; i++) {
        tablero.push({ emoji: cartas[i], estado: 'oculta' });
        let cartaDiv = document.createElement('div');
        cartaDiv.className = 'carta';
        cartaDiv.dataset.indice = i;
        cartaDiv.onclick = () => voltearCarta(i);
        tableroDiv.appendChild(cartaDiv);
      }
      renderizar();
      ocultarConfeti();
    }
    function renderizar() {
      const tableroDiv = document.getElementById('tablero');
      tableroDiv.querySelectorAll('.carta').forEach((cartaDiv, i) => {
        let carta = tablero[i];
        if (carta.estado === 'oculta') {
          cartaDiv.textContent = '';
          cartaDiv.className = 'carta';
        } else if (carta.estado === 'volteada') {
          cartaDiv.textContent = carta.emoji;
          cartaDiv.className = 'carta volteada';
        } else if (carta.estado === 'pareja') {
          cartaDiv.textContent = carta.emoji;
          cartaDiv.className = 'carta pareja';
        }
      });
    }
    function voltearCarta(indice) {
      if (juegoTerminado) return;
      if (tablero[indice].estado !== 'oculta' || volteadas.length === 2) return;
      if (modo === 'reloj' && !jugando) {
        jugando = true;
        iniciarCronometro();
      }
      tablero[indice].estado = 'volteada';
      volteadas.push(indice);
      renderizar();
      if (volteadas.length === 2) {
        if (modo === 'movimientos') {
          movimientos++;
          document.getElementById('contMovimientos').textContent = movimientos;
        }
        setTimeout(() => {
          comprobarPareja();
        }, 700);
      }
    }
    function comprobarPareja() {
      let [a, b] = volteadas;
      if (tablero[a].emoji === tablero[b].emoji) {
        tablero[a].estado = tablero[b].estado = 'pareja';
        parejasEncontradas++;
        if (parejasEncontradas === cantidadPares) {
          juegoTerminado = true;
          detenerCronometro();
          setTimeout(() => mensajeFinal(), 200);
        }
      } else {
        tablero[a].estado = tablero[b].estado = 'oculta';
      }
      volteadas = [];
      renderizar();
    }
    function mensajeFinal() {
      const dif = document.getElementById('dificultad').value;
      const mod = modo;
      let recordAnterior = obtenerRecord(dif, mod);
      let nuevoRecord = false;
      const felicitacionesDiv = document.getElementById('felicitaciones');
      felicitacionesDiv.classList.remove('animar-felicidades');
      if (modo === 'movimientos') {
        felicitacionesDiv.textContent =
          `Â¡Felicidades, ganaste en ${movimientos} movimientos!`;
        if (recordAnterior == null || movimientos < recordAnterior) {
          guardarRecord(dif, modo, movimientos);
          nuevoRecord = true;
        }
      } else if (modo === 'reloj') {
        felicitacionesDiv.textContent =
          "Â¡Felicidades, tardaste " + formarTiempo(tiempoTranscurrido) + "!";
        if (recordAnterior == null || tiempoTranscurrido < recordAnterior) {
          guardarRecord(dif, modo, tiempoTranscurrido);
          nuevoRecord = true;
        }
      }
      mostrarRecord();
      if (nuevoRecord) {
        mostrarNuevoRecordAnimado();
      }
      document.getElementById('volver-menu-btn').style.display = 'inline-block';
      document.getElementById('abandonar-btn').style.display = 'none';
      document.getElementById('reset-record-btn').style.display = 'inline-block';
      setTimeout(() => {
        felicitacionesDiv.classList.add('animar-felicidades');
      }, 50);
      mostrarConfeti();
    }
    function volverAlMenu() {
      detenerCronometro();
      document.getElementById('menu').style.display = 'block';
      document.getElementById('memoria-juego').style.display = 'none';
      document.getElementById('reiniciar-btn').style.display = 'none';
      document.getElementById('abandonar-btn').style.display = 'none';
      document.getElementById('reset-record-btn').style.display = 'none';
      document.getElementById('volver-menu-btn').style.display = 'none';
      document.getElementById('felicitaciones').textContent = '';
      document.getElementById('nuevo-record').textContent = '';
      document.getElementById('nuevo-record').classList.remove('animar-record');
      cerrarModalConfirmacion();
      ocultarConfeti();
    }
    function iniciarCronometro() {
      detenerCronometro();
      intervalo = setInterval(() => {
        tiempoTranscurrido++;
        actualizarCronometro();
      }, 1000);
    }
    function detenerCronometro() {
      if (intervalo) clearInterval(intervalo);
      intervalo = null;
    }
    function actualizarCronometro() {
      document.getElementById('tiempo').textContent = formarTiempo(tiempoTranscurrido);
    }
    function formarTiempo(segundos) {
      const min = Math.floor(segundos/60).toString().padStart(2,'0');
      const seg = (segundos%60).toString().padStart(2,'0');
      return min + ":" + seg;
    }
    // Confeti victoria
    function mostrarConfeti() {
      const canvas = document.getElementById('confetti-canvas');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.style.display = "block";
      let ctx = canvas.getContext('2d');
      let pieces = [];
      let colors = [
        "#f44336", "#fbc02d", "#388e3c", "#1976d2", "#8e24aa", "#fff"
      ];
      const N = 60;
      for (let i=0; i<N; i++) {
        pieces.push({
          x: Math.random()*canvas.width,
          y: -20 - Math.random()*canvas.height/3,
          r: 4 + Math.random()*7,
          d: Math.random()*N,
          color: colors[Math.floor(Math.random()*colors.length)],
          tilt: Math.random()*10-10,
          tiltAngle: 0,
          tiltAngleIncremental: (Math.random()*0.07)+.05,
          fallSpeed: 2 + Math.random()*2.8,
        });
      }
      let angle = 0;
      function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(let i=0; i<pieces.length; i++){
          let p = pieces[i];
          ctx.beginPath();
          ctx.lineWidth = p.r;
          ctx.strokeStyle = p.color;
          ctx.moveTo(p.x + p.tilt + p.r/3, p.y);
          ctx.lineTo(p.x + p.tilt, p.y + p.r*2);
          ctx.stroke();
        }
        update();
      }
      function update(){
        angle += 0.01;
        for(let i=0;i<pieces.length;i++){
          let p = pieces[i];
          p.y += p.fallSpeed;
          p.x += Math.sin(angle+p.d)*1.2;
          p.tiltAngle += p.tiltAngleIncremental;
          p.tilt = Math.sin(p.tiltAngle)*14;
          if(p.y > canvas.height+20){
            p.x = Math.random()*canvas.width;
            p.y = -20;
            p.d = Math.random()*N;
          }
        }
      }
      let confettiTimer = setInterval(draw,1000/55);
      setTimeout(() => {
        clearInterval(confettiTimer);
        canvas.style.display = "none";
      }, 3400);
    }
    function ocultarConfeti() {
      const canvas = document.getElementById('confetti-canvas');
      canvas.style.display = "none";
    }
    window.addEventListener("resize", ()=> {
      const canvas = document.getElementById('confetti-canvas');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
  </script>
</body>
</html>
